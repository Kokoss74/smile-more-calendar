### __План реализации MVP "Smile More Calendar"__

#### __Фаза 0: Фундамент и настройка окружения__

Это подготовительный этап, на котором мы закладываем основу для всего приложения. Без него дальнейшая разработка невозможна.

1. __Установка зависимостей:__ Добавим в `package.json` все необходимые библиотеки согласно технологическому стеку:

   - UI: `@mui/material`, `@mui/icons-material`, `@emotion/react`, `@emotion/styled`.
   - Календарь: `@fullcalendar/react`, `@fullcalendar/daygrid`, `@fullcalendar/timegrid`, `@fullcalendar/interaction`.
   - State Management: `@tanstack/react-query`, `zustand`.
   - Формы: `react-hook-form`, `zod`, `@hookform/resolvers`.
   - Supabase: `@supabase/supabase-js`, `@supabase/ssr`.
   - PWA: `next-pwa`.

2. __Настройка Supabase:__

   - Инициализация Supabase CLI в проекте (`supabase init`).
   - Связывание локального проекта с вашим удаленным проектом в Supabase (`supabase link`).
   - Создание миграций SQL для всех таблиц, описанных в разделе 3.1 (`clinics`, `patients`, `appointments` и т.д.).
   - Создание миграций для вспомогательных функций (`current_role`, `current_clinic`), RLS-политик и триггера `check_appointment_overlap`.
   - Создание файла `supabase/seed.sql` для начального наполнения справочников (`clinics`, `procedures_catalog`, `wa_templates`).

3. __Конфигурация окружения:__ Настройка файла `.env.local` для хранения ключей Supabase (`NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`).

4. __Интеграция Material UI:__ Настройка кастомного провайдера темы MUI для всего приложения, чтобы обеспечить консистентный дизайн.

#### __Фаза 1: Аутентификация и базовый каркас приложения__

На этом этапе мы реализуем вход в систему и создадим защищенный основной макет приложения.

1. __Реализация аутентификации:__ Настройка входа через Google OAuth с использованием `supabase-js`. Создание страниц входа/выхода и обработка сессий.
2. __Создание ролей и профилей:__ Реализация логики, которая после входа пользователя определяет его роль (`admin` или `clinic_staff`) из таблицы `profiles`.
3. __Создание основного макета (App Shell):__ Разработка главного компонента-макета с навигацией (боковое меню `Drawer` для мобильных, как указано в документации) и защищенными роутами, доступными только аутентифицированным пользователям.

#### __Фаза 2: CRUD-интерфейсы для управления данными__

После настройки аутентификации `admin` должен получить возможность управлять основными сущностями системы. Все интерфейсы создаются с приоритетом Mobile-First.

1. Управление клиниками (`clinics`).
2. Управление каталогом процедур (`procedures_catalog`).
3. Управление пациентами (`patients`).
4. Управление шаблонами приёмов (`appointment_templates`).
5. Управление шаблонами сообщений WhatsApp (`wa_templates`).

#### __Фаза 3.1: Основной функционал — Календарь__

Это ядро приложения. Здесь мы оживим календарь и его основную логику.

1. __Интеграция FullCalendar:__ Встраивание компонента календаря на главную страницу.
2. __Отображение приёмов:__ Загрузка и отображение записей из таблицы `appointments` с учетом RLS. Реализация цветовой кодировки: фон события — цвет клиники, левая граница — цвет процедуры.
3. __Управление приёмами:__ Реализация создания, редактирования (drag-and-drop) и отмены приёмов через диалоговые окна (MUI `Dialog`) с формами на `React Hook Form` + `Zod`.
4. __Переключение видов:__ Добавление переключателей "День", "Неделя", "Месяц" с видом "Неделя" по умолчанию.


### Фаза 3.2: Завершение и улучшение основного функционала

**Цель:** Завершить работу над календарем, внедрив предложенные архитектурные и UX-улучшения, чтобы сделать его готовым к реальному использованию.

#### **Шаг 1: Рефакторинг Схемы Данных (Foundation First)**
*Это необходимо сделать в первую очередь, чтобы все последующие изменения UI строились на актуальной структуре БД.*
1.  **Создать новую миграцию Supabase:**
    *   Удалить таблицу `appointment_templates`.
    *   В таблицу `procedures_catalog` добавить поля `default_duration_min` (integer) и `default_cost` (numeric).
    *   В таблице `patients` заменить поле `age` на `patient_type` (text). Добавить поле `notification_language_is_hebrew` (boolean, default false).
    *   В таблице `appointments` переименовать поле `private` в `send_notifications` (boolean, default true).
2.  **Применить миграцию** к локальной и удаленной базе данных.
3.  **Обновить файл `seed.sql`**, чтобы он наполнял новые поля в `procedures_catalog`.
4.  **Обновить типы TypeScript** (`src/types/index.ts`) и схемы валидации `zod` в соответствии с новой структурой таблиц.

#### **Шаг 2: Обновление CRUD-интерфейсов в соответствии с новой схемой**
*После изменения БД нужно привести в порядок затронутые разделы.*
1.  **Раздел "Procedures":**
    *   Удалить из навигации раздел "Appointment Templates".
    *   В форме добавления/редактирования процедуры (`ProcedureFormDialog`) добавить поля для "Длительности по умолчанию" и "Стоимости по умолчанию".
    *   Обновить хуки (`useProcedures`, etc.) для работы с новыми полями.
2.  **Раздел "Patients":**
    *   В форме `PatientFormDialog` заменить поле "Возраст" на выпадающий список "Тип пациента" (`Взрослый`, `Ребёнок`, `Израильтянин`, `Близкий`).
    *   Добавить в форму чекбокс или переключатель для выбора языка уведомлений ("Уведомления на иврите").
    *   Обновить хуки (`usePatients`, etc.) и таблицу для отображения новой информации.

#### **Шаг 3: Улучшение UX/UI Календаря и Формы Записи**
*Фокусируемся на основном рабочем инструменте.*
1.  **Форма `AppointmentFormDialog`:**
    *   Реализовать логику выбора клиники для **администратора** (радио-кнопки). Для остальных ролей — автоматическое определение клиники.
    *   Добавить чекбокс "Отправлять уведомления", привязанный к полю `send_notifications`.
    *   В компоненте выбора даты (`DatePicker`) установить опцию `disablePast` для блокировки прошлых дат.
    *   При выборе процедуры из списка, автоматически подставлять значения `default_duration_min` и `default_cost` в соответствующие поля формы.
2.  **Логика Календаря:**
    *   При удалении события (`onEventClick` -> delete) вызывать модальное окно `ConfirmDialog` для подтверждения действия.

#### **Шаг 4: Реализация Управления Доступностью (Нерабочее время)**
*Добавляем новую ключевую фичу.*
1.  Продумать реализацию. Возможный вариант: создать специальный тип записей в таблице `appointments` (например, с `patient_id = NULL` и специальным `procedure_id` для "Блокировки времени").
2.  Добавить в UI календаря для администратора простой способ создавать такие "блокирующие" события (например, через специальную кнопку или опцию в контекстном меню).
3.  Обновить триггер `check_appointment_overlap`, чтобы он корректно обрабатывал эти блокировки и не давал создавать записи поверх них.

#### **Шаг 5: Завершающие Улучшения UX**
*Последние штрихи для повышения удобства.*
1.  **Страница `/patients`:**
    *   Добавить `TextField` для поиска.
    *   Реализовать логику фильтрации списка на клиенте или через параметры запроса к Supabase.
    *   Доработать компонент таблицы, чтобы заголовки были кликабельными для смены направления сортировки.
2.  **Компонент выбора пациента в форме:**
    *   Заменить стандартный `Select` на компонент `Autocomplete` от MUI, который "из коробки" поддерживает текстовый поиск по списку.

#### __Фаза 4: Интеграции и PWA__

Завершаем MVP, добавляя оставшийся критический функционал.

1. __Загрузка файлов:__ Реализация загрузки файлов пациентов в Supabase Storage с использованием URL-трансформаций для предпросмотра.
2. __Интеграция WhatsApp:__ Создание Edge-функции `wa-notify` на Deno для асинхронной отправки уведомлений через Twilio. Настройка триггеров (создание/отмена приёма) и cron-задачи для напоминаний.
3. __Настройка PWA:__ Конфигурация `next-pwa` для обеспечения возможности установки приложения на главный экран и базовой работы в offline-режиме.

#### __Фаза 5: Финализация и развертывание__

Подготовка проекта к запуску в продуктив.

1. __Интеграция аналитики:__ Подключение Hotjar для анализа поведения пользователей.
2. __Тестирование:__ Проведение полного цикла ручного тестирования ключевых сценариев на реальных мобильных и десктопных устройствах.
3. __Деплой:__ Настройка CI/CD через Vercel и окончательное развертывание проекта.
