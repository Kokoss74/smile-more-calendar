# Дорожная карта проекта "Smile More Calendar"

Этот документ описывает дальнейшие шаги по развитию проекта, начиная с текущего момента.

---

### Фаза 3.4: Расширение UX/UI на странице "Пациенты"

**Цель:** Предоставить администратору быстрый доступ к истории посещений пациента прямо из его карточки.

#### **Шаг 1: Реализация отображения истории приемов**
1.  **Доработать UI карточки пациента (`PatientFormDialog`):**
    *   Под основной информацией о пациенте добавить новую секцию "История приемов".
    *   В этой секции разместить таблицу (MUI DataGrid или аналогичный компонент) со списком всех приемов данного пациента.
    *   Колонки таблицы: `Дата`, `Процедура`, `Статус` (`scheduled`, `completed`, `canceled`).

#### **Шаг 2: Реализация детального просмотра приема**
1.  **Создать модальное окно для просмотра сведений:**
    *   При клике на строку в таблице истории должен открываться диалог (в режиме "только для чтения") с полной информацией о выбранном приеме.
    *   Отображаемые поля:
        *   Дата и время приема
        *   Процедура
        *   Номер зуба
        *   Описание
        *   Стоимость
        *   Статус (`scheduled`, `completed`, `canceled`)

**К чему мы придем по итогу Фазы 3.4:** Администратор получит мощный инструмент для анализа истории взаимодействия с пациентом, что значительно ускорит работу и повысит качество обслуживания.

---

### Фаза 3.5: Блокировка редактирования завершенных приемов

**Цель:** Обеспечить целостность финансовых и медицинских данных путем предотвращения случайных или намеренных изменений в уже завершенных записях.

#### **Шаг 1: Реализация логики блокировки в UI**
1.  **Доработать `AppointmentFormDialog`:**
    *   Реализовать логику, при которой если запись открывается со статусом `completed`, большинство полей формы становятся неактивными (read-only).
    *   Поля для блокировки: `Дата`, `Время`, `Продолжительность`, `Пациент`, `Процедура`, `Стоимость`, `Номер зуба`.
    *   Кнопка "Удалить" также должна быть скрыта или неактивна для записей со статусом `completed`.
    *   Пользователь сможет изменять только поле `Описание` или `Заметки`, если это необходимо.

**К чему мы придем по итогу Фазы 3.5:** Система станет более надежной, так как история приемов будет защищена от непреднамеренных изменений, что критически важно для ведения учета.

---

### Фаза 3.6: Внедрение и рефакторинг логики `owner_id` для пациентов

**Цель:** Реализовать корректное разграничение доступа к данным пациентов, основываясь на клинике, к которой привязан прием.

#### **Шаг 1: Рефакторинг логики создания приема**
1.  **Доработать `AppointmentFormDialog`:**
    *   При сохранении **приема** администратором, реализовать следующую логику:
        *   Если в приеме выбрана "Smile More Clinic" (личная клиника администратора), то у связанного пациента в таблице `patients` поле `owner_id` должно быть установлено в `user_id` администратора.
        *   Если выбрана любая другая клиника, то у связанного пациента поле `owner_id` должно быть установлено в `NULL`.
    *   Эта логика должна применяться как при создании нового пациента из формы приема, так и при привязке существующего.
2.  **Проверить хуки (`useAddAppointment`, `useUpdateAppointment`):** Убедиться, что они включают логику для обновления `owner_id` у пациента при необходимости.

#### **Шаг 2: Обновление RLS-политик и логики отображения**
1.  **Скорректировать RLS-политики для `patients`:**
    *   **Администратор (`admin`)** по-прежнему видит всех пациентов.
    *   **Сотрудник клиники (`clinic_staff`)** может видеть пациента, если `owner_id` этого пациента `IS NULL`.
2.  **Обновить хук `useAppointments`:**
    *   Для роли `clinic_staff` хук должен загружать:
        *   Все приемы своей клиники.
        *   Если у приема есть `patient_id`, и этот пациент является "общим" (`owner_id IS NULL`), то отображать полную информацию о приеме (имя пациента и т.д.).
        *   Если у приема есть `patient_id`, но пациент "приватный" (`owner_id` не `NULL`), то отображать прием как обезличенный ("Время занято").
        *   Если у приема нет `patient_id` (запись создана сотрудником клиники с `short_label`), отображать `short_label`.

**К чему мы придем по итогу Фазы 3.6:** Будет реализована простая и надежная система разграничения доступа. Администратор сможет легко управлять видимостью пациентов, просто выбирая клинику при создании записи. Сотрудники клиник будут видеть всю необходимую им информацию, не получая доступа к личным данным администратора.

---

### Фаза 4: Интеграции и PWA

**Цель:** Завершить MVP, добавив оставшийся критический функционал.

1.  **Интеграция WhatsApp:** Создание Edge-функции `wa-notify` на Deno для асинхронной отправки уведомлений через Twilio. Настройка триггеров (создание/отмена приёма) и cron-задачи для напоминаний.
2.  **Настройка PWA:** Конфигурация `next-pwa` для обеспечения возможности установки приложения на главный экран и базовой работы в offline-режиме.

---

### Фаза 5: Финализация и развертывание

**Цель:** Подготовить проект к запуску в продуктив.

1.  **Тестирование:** Проведение полного цикла ручного тестирования ключевых сценариев на реальных мобильных и десктопных устройствах.
2.  **Деплой:** Настройка CI/CD через Vercel и окончательное развертывание проекта.

---

### Post-MVP (v1.1 и далее)

Задачи, которые будут реализованы после запуска основной версии продукта:

-   **Загрузка файлов:** Реализация загрузки файлов пациентов (снимки, документы) в Supabase Storage с использованием URL-трансформаций для предпросмотра.
-   **Интеграция Hotjar:** Подключение сервиса для анализа поведения пользователей.
-   **Аналитика и отчетность:**
    -   Создание UI для просмотра логов аудита и дашбордов с ключевыми метриками.
    -   Реализация экспорта приемов в Excel (может быть доступно только в десктопной версии).
-   **Расширение функционала:**
    -   Внедрение роли `assistant`.
    -   Offline-кэширование данных (через IndexedDB) для полноценной работы без сети.
-   **Безопасность:** Усиление безопасности (например, WebAuthn).
