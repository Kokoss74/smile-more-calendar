# Дорожная карта проекта "Smile More Calendar"

Этот документ описывает дальнейшие шаги по развитию проекта, начиная с текущего момента.

---

### Фаза 3.4: Расширение UX/UI на странице "Пациенты" (ЗАВЕРШЕНО)

**Цель:** Предоставить администратору быстрый доступ к истории посещений пациента прямо из его карточки.

**Результат:**
- **Реализована история приемов:** В диалоговое окно редактирования пациента (`PatientFormDialog`) добавлена новая секция "История приемов" с таблицей визитов.
- **Создан хук `usePatientAppointments`:** Для эффективной загрузки истории конкретного пациента.
- **Реализован детальный просмотр:** При клике на запись в истории открывается модальное окно с полной информацией о приеме (дата, процедура, стоимость, номер зуба, описание).

**Итог:** Администратор получил мощный инструмент для анализа истории взаимодействия с пациентом, что значительно ускоряет работу и повышает качество обслуживания.

---

### Фаза 3.5: Блокировка редактирования завершенных приемов (ЗАВЕРШЕНО)

**Цель:** Обеспечить целостность финансовых и медицинских данных путем предотвращения случайных или намеренных изменений в уже завершенных записях.

**Результат:**
- **Реализована блокировка UI:** В компоненте `AppointmentFormDialog` внедрена логика, которая делает все поля, кроме "Описания", неактивными (`disabled`), если прием имеет статус `completed`.
- **Улучшен UX:** Вместо группы радио-кнопок для статусов теперь используется чекбокс "Mark as Completed". При его активации форма блокируется, а при деактивации — возвращается в состояние `scheduled`.
- **Защита от удаления:** Кнопка удаления записи также становится неактивной для завершенных приемов.

**Итог:** Система стала более надежной. История приемов теперь защищена от непреднамеренных изменений, что критически важно для ведения финансового и медицинского учета.

---

### Фаза 3.6: Внедрение и рефакторинг логики `owner_id` для пациентов

**Цель:** Реализовать корректное разграничение доступа к данным пациентов, основываясь на клинике, к которой привязан прием.

#### **Шаг 1: Рефакторинг логики создания приема**
1.  **Доработать `AppointmentFormDialog`:**
    *   При сохранении **приема** администратором, реализовать следующую логику:
        *   Если в приеме выбрана "Smile More Clinic" (личная клиника администратора), то у связанного пациента в таблице `patients` поле `owner_id` должно быть установлено в `user_id` администратора.
        *   Если выбрана любая другая клиника, то у связанного пациента поле `owner_id` должно быть установлено в `NULL`.
    *   Эта логика должна применяться как при создании нового пациента из формы приема, так и при привязке существующего.
2.  **Проверить хуки (`useAddAppointment`, `useUpdateAppointment`):** Убедиться, что они включают логику для обновления `owner_id` у пациента при необходимости.

#### **Шаг 2: Обновление RLS-политик и логики отображения**
1.  **Скорректировать RLS-политики для `patients`:**
    *   **Администратор (`admin`)** по-прежнему видит всех пациентов.
    *   **Сотрудник клиники (`clinic_staff`)** может видеть пациента, если `owner_id` этого пациента `IS NULL`.
2.  **Обновить хук `useAppointments`:**
    *   Для роли `clinic_staff` хук должен загружать:
        *   Все приемы своей клиники.
        *   Если у приема есть `patient_id`, и этот пациент является "общим" (`owner_id IS NULL`), то отображать полную информацию о приеме (имя пациента и т.д.).
        *   Если у приема есть `patient_id`, но пациент "приватный" (`owner_id` не `NULL`), то отображать прием как обезличенный ("Время занято").
        *   Если у приема нет `patient_id` (запись создана сотрудником клиники с `short_label`), отображать `short_label`.

**К чему мы придем по итогу Фазы 3.6:** Будет реализована простая и надежная система разграничения доступа. Администратор сможет легко управлять видимостью пациентов, просто выбирая клинику при создании записи. Сотрудники клиник будут видеть всю необходимую им информацию, не получая доступа к личным данным администратора.

---

### Фаза 3.7: Пользовательский сценарий для `clinic_staff`

**Цель:** Реализовать и протестировать полный и ограниченный рабочий цикл для роли `clinic_staff`.

#### **Шаг 1: Реализация ограниченной формы создания приема**
1.  **Адаптировать `AppointmentFormDialog` для `clinic_staff`:**
    *   При открытии формы сотрудником клиники, она должна иметь урезанный функционал.
    *   Поля для заполнения: `short_label` (текстовое поле, обязательное), `start_ts`, `duration` (выбор из списка), `cost`, `description`.
    *   Поля `patient_id`, `procedure_id`, `tooth_num` должны быть скрыты.
    *   При сохранении создается запись в `appointments` без привязки к пациенту (`patient_id` = `NULL`).

#### **Шаг 2: Реализация отмены приема**
1.  **Обеспечить возможность отмены:**
    *   Сотрудник клиники должен иметь возможность кликнуть на созданную им запись и изменить ее статус на `canceled`.
    *   Другие статусы (`completed`, `blocked`) должны быть недоступны.

#### **Шаг 3: Комплексное тестирование**
1.  **Провести полный цикл тестирования под ролью `clinic_staff`:**
    *   Убедиться, что сотрудник видит только календарь своей клиники.
    *   Проверить, что он видит "общих" пациентов, созданных администратором для их клиники.
    *   Проверить, что он видит "приватных" пациентов администратора как обезличенные занятые слоты.
    *   Проверить полный цикл создания и отмены "своих" записей с `short_label`.

**К чему мы придем по итогу Фазы 3.7:** Роль `clinic_staff` будет полностью готова к работе в соответствии с бизнес-требованиями.

---

### Фаза 3.8: Интерактивное управление приемами в календаре

**Цель:** Улучшить UX, добавив возможность изменять время и длительность приемов путем перетаскивания в календаре.

#### **Шаг 1: Реализация Drag-and-Drop**
1.  **Включить и настроить `eventDrop` в FullCalendar:**
    *   Пользователи должны иметь возможность "схватить" событие в календаре и перетащить его на другой день или время.
    *   **Разграничение прав:**
        *   **Администратор** может перетаскивать любые события.
        *   **Сотрудник клиники** может перетаскивать только "свои" записи (`short_label`) или записи "общих" пациентов (`owner_id IS NULL`). Попытка перетащить "приватную" запись администратора должна блокироваться с выводом уведомления.
    *   После перетаскивания должна срабатывать мутация `useUpdateAppointment` для сохранения нового времени (`start_ts`, `end_ts`).
    *   Необходимо добавить валидацию, чтобы предотвратить перетаскивание в уже занятый слот (с выводом уведомления).

#### **Шаг 2: Реализация Resizing**
1.  **Включить и настроить `eventResize` в FullCalendar:**
    *   Пользователи должны иметь возможность изменять длительность приема, потянув за границу события.
    *   **Разграничение прав:** Аналогично Drag-and-Drop, сотрудник клиники может изменять длительность только "своих" и "общих" записей.
    *   После изменения размера должна срабатывать мутация `useUpdateAppointment`.
    *   Также необходима валидация на пересечение с другими событиями (с выводом уведомления).

**К чему мы придем по итогу Фазы 3.8:** Управление расписанием станет значительно быстрее и интуитивнее, что является ключевым требованием для daily-use инструмента.

---

### Фаза 4: Интеграции и PWA

**Цель:** Завершить MVP, добавив оставшийся критический функционал.

1.  **Интеграция WhatsApp:** Создание Edge-функции `wa-notify` на Deno для асинхронной отправки уведомлений через Twilio. Настройка триггеров (создание/отмена приёма) и cron-задачи для напоминаний.
2.  **Настройка PWA:** Конфигурация `next-pwa` для обеспечения возможности установки приложения на главный экран и базовой работы в offline-режиме.

---

### Фаза 5: Финализация и развертывание

**Цель:** Подготовить проект к запуску в продуктив.

1.  **Тестирование:** Проведение полного цикла ручного тестирования ключевых сценариев на реальных мобильных и десктопных устройствах.
2.  **Деплой:** Настройка CI/CD через Vercel и окончательное развертывание проекта.

---

### Post-MVP (v1.1 и далее)

Задачи, которые будут реализованы после запуска основной версии продукта:

-   **Загрузка файлов:** Реализация загрузки файлов пациентов (снимки, документы) в Supabase Storage с использованием URL-трансформаций для предпросмотра.
-   **Интеграция Hotjar:** Подключение сервиса для анализа поведения пользователей.
-   **Аналитика и отчетность:**
    -   Создание UI для просмотра логов аудита и дашбордов с ключевыми метриками.
    -   Реализация экспорта приемов в Excel (может быть доступно только в десктопной версии).
-   **Расширение функционала:**
    -   Внедрение роли `assistant`.
    -   Offline-кэширование данных (через IndexedDB) для полноценной работы без сети.
-   **Безопасность:** Усиление безопасности (например, WebAuthn).
