### __План реализации MVP "Smile More Calendar"__

#### __Фаза 0: Фундамент и настройка окружения__

Это подготовительный этап, на котором мы закладываем основу для всего приложения. Без него дальнейшая разработка невозможна.

1. __Установка зависимостей:__ Добавим в `package.json` все необходимые библиотеки согласно технологическому стеку:

   - UI: `@mui/material`, `@mui/icons-material`, `@emotion/react`, `@emotion/styled`.
   - Календарь: `@fullcalendar/react`, `@fullcalendar/daygrid`, `@fullcalendar/timegrid`, `@fullcalendar/interaction`.
   - State Management: `@tanstack/react-query`, `zustand`.
   - Формы: `react-hook-form`, `zod`, `@hookform/resolvers`.
   - Supabase: `@supabase/supabase-js`, `@supabase/ssr`.
   - PWA: `next-pwa`.

2. __Настройка Supabase:__

   - Инициализация Supabase CLI в проекте (`supabase init`).
   - Связывание локального проекта с вашим удаленным проектом в Supabase (`supabase link`).
   - Создание миграций SQL для всех таблиц, описанных в разделе 3.1 (`clinics`, `patients`, `appointments` и т.д.).
   - Создание миграций для вспомогательных функций (`current_role`, `current_clinic`), RLS-политик и триггера `check_appointment_overlap`.
   - Создание файла `supabase/seed.sql` для начального наполнения справочников (`clinics`, `procedures_catalog`, `wa_templates`).

3. __Конфигурация окружения:__ Настройка файла `.env.local` для хранения ключей Supabase (`NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`).

4. __Интеграция Material UI:__ Настройка кастомного провайдера темы MUI для всего приложения, чтобы обеспечить консистентный дизайн.

#### __Фаза 1: Аутентификация и базовый каркас приложения__

На этом этапе мы реализуем вход в систему и создадим защищенный основной макет приложения.

1. __Реализация аутентификации:__ Настройка входа через Google OAuth с использованием `supabase-js`. Создание страниц входа/выхода и обработка сессий.
2. __Создание ролей и профилей:__ Реализация логики, которая после входа пользователя определяет его роль (`admin` или `clinic_staff`) из таблицы `profiles`.
3. __Создание основного макета (App Shell):__ Разработка главного компонента-макета с навигацией (боковое меню `Drawer` для мобильных, как указано в документации) и защищенными роутами, доступными только аутентифицированным пользователям.

#### __Фаза 2: CRUD-интерфейсы для управления данными__

После настройки аутентификации `admin` должен получить возможность управлять основными сущностями системы. Все интерфейсы создаются с приоритетом Mobile-First.

1. Управление клиниками (`clinics`).
2. Управление каталогом процедур (`procedures_catalog`).
3. Управление пациентами (`patients`).
4. Управление шаблонами приёмов (`appointment_templates`).
5. Управление шаблонами сообщений WhatsApp (`wa_templates`).

#### __Фаза 3.1: Основной функционал — Календарь__

Это ядро приложения. Здесь мы оживим календарь и его основную логику.

1. __Интеграция FullCalendar:__ Встраивание компонента календаря на главную страницу.
2. __Отображение приёмов:__ Загрузка и отображение записей из таблицы `appointments` с учетом RLS. Реализация цветовой кодировки: фон события — цвет клиники, левая граница — цвет процедуры.
3. __Управление приёмами:__ Реализация создания, редактирования (drag-and-drop) и отмены приёмов через диалоговые окна (MUI `Dialog`) с формами на `React Hook Form` + `Zod`.
4. __Переключение видов:__ Добавление переключателей "День", "Неделя", "Месяц" с видом "Неделя" по умолчанию.

### Фаза 3.2: Архитектурный рефакторинг и стабилизация

**Цель:** Упростить модель данных, устранить лишние сущности и адаптировать существующие CRUD-интерфейсы под новую, более логичную структуру. После этой фазы основной функционал календаря не изменится, но "под капотом" система станет чище и готовой к дальнейшим улучшениям.

#### **Шаг 1: Рефакторинг Схемы Данных (Foundation First)**
1.  **Создать и применить миграцию Supabase:**
    *   **Удалить** таблицу `appointment_templates`.
    *   **Добавить** в таблицу `procedures_catalog` поля `default_duration_min` (integer) и `default_cost` (numeric).
    *   **Изменить** в таблице `patients` поле `age` на `patient_type` (text).
    *   **Добавить** в таблицу `patients` поле `notification_language_is_hebrew` (boolean, default false).
    *   **Переименовать** в таблице `appointments` поле `private` в `send_notifications` (boolean, default true).
2.  **Обновить файл `seed.sql`** для корректного наполнения `procedures_catalog` с новыми полями.
3.  **Обновить типы TypeScript** (`src/types/index.ts`) и схемы валидации `zod`, чтобы они отражали новую структуру таблиц.

#### **Шаг 2: Адаптация UI под новую схему**
*Приводим в порядок интерфейсы, которые были затронуты изменениями в БД.*
1.  **Раздел "Procedures":**
    *   Удалить из навигационного меню (`src/config/navigation.ts`) пункт "Appointment Templates".
    *   В форме `ProcedureFormDialog` добавить поля для ввода "Длительности по умолчанию" и "Стоимости по умолчанию".
    *   Обновить хуки (`useProcedures`, `useAddProcedure` и т.д.) для работы с новыми полями.
2.  **Раздел "Patients":**
    *   В форме `PatientFormDialog` заменить поле "Возраст" на выпадающий список "Тип пациента" (значения: `Взрослый`, `Ребёнок`, `Израильтянин`, `Близкий`).
    *   Добавить в ту же форму переключатель "Уведомления на иврите".
    *   Обновить хуки (`usePatients`, etc.) и таблицу для корректной работы с новыми данными.

**К чему мы придем по итогу Фазы 3.2:** Система будет работать на обновленной, более чистой архитектуре. Разделы управления процедурами и пациентами будут соответствовать новой схеме данных. Приложение будет полностью стабильно и готово к следующему этапу внедрения нового функционала.

---

### Фаза 3.3: Внедрение ключевых UX-улучшений и нового функционала

**Цель:** Значительно улучшить пользовательский опыт при работе с календарем и списком пациентов, а также добавить критически важную функцию управления нерабочим временем.

#### **Шаг 1: Улучшение UX/UI Календаря и Формы Записи**
*Фокусируемся на основном рабочем инструменте.*
1.  **Форма `AppointmentFormDialog`:**
    *   Реализовать условное отображение радио-кнопок выбора клиники **только для роли `admin`**.
    *   Добавить чекбокс "Отправлять уведомления", связанный с полем `send_notifications`.
    *   Настроить `DatePicker` так, чтобы он не позволял выбирать прошедшие даты (`disablePast`).
    *   Реализовать автозаполнение полей "Длительность" и "Стоимость" при выборе процедуры.
2.  **Логика Календаря:**
    *   При удалении события из календаря реализовать вызов модального окна `ConfirmDialog` для подтверждения действия.

#### **Шаг 2: Улучшение UX Управления Пациентами**
*Делаем работу со списком пациентов быстрой и удобной.*
1.  **Страница `/patients`:**
    *   Добавить текстовое поле для живого поиска/фильтрации списка.
    *   Реализовать смену направления сортировки по клику на заголовки столбцов таблицы.
2.  **Форма `AppointmentFormDialog`:**
    *   Заменить текущий выпадающий список пациентов на компонент `Autocomplete` от MUI, чтобы обеспечить быстрый поиск пациента при создании записи.

#### **Шаг 3: Реализация Управления Доступностью (Нерабочее время)**
*Добавляем новую ключевую фичу.*
1.  **Продумать и реализовать способ хранения "блокировок"**. Например, через создание специального типа записей в таблице `appointments`.
2.  **Создать UI для администратора**, позволяющий легко блокировать целый день, диапазон дат или временной интервал в календаре.
3.  **Убедиться, что триггер `check_appointment_overlap`** и логика создания новых записей корректно учитывают эти заблокированные слоты.

**К чему мы придем по итогу Фазы 3.3:** Основной функционал приложения будет значительно улучшен. Процесс создания записи станет умнее и удобнее, работа со списком пациентов — быстрее, а у администратора появится жизненно важный инструмент для управления своим расписанием.

---

### Что дальше по плану
После завершения **Фазы 3.3** ядро приложения будет полностью готово. Мы сможем перейти к следующим этапам, как и планировалось изначально.

#### __Фаза 4: Интеграции и PWA__

Завершаем MVP, добавляя оставшийся критический функционал.

1. __Интеграция WhatsApp:__ Создание Edge-функции `wa-notify` на Deno для асинхронной отправки уведомлений через Twilio. Настройка триггеров (создание/отмена приёма) и cron-задачи для напоминаний.
2. __Настройка PWA:__ Конфигурация `next-pwa` для обеспечения возможности установки приложения на главный экран и базовой работы в offline-режиме.

#### __Фаза 5: Финализация и развертывание__

Подготовка проекта к запуску в продуктив.

1. __Тестирование:__ Проведение полного цикла ручного тестирования ключевых сценариев на реальных мобильных и десктопных устройствах.
2. __Деплой:__ Настройка CI/CD через Vercel и окончательное развертывание проекта.
